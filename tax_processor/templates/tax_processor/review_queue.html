{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ title }}</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 30px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
        h1 { color: #007bff; font-size: 2em; border-bottom: 2px solid #ccc; padding-bottom: 10px; margin-top: 0; margin-bottom: 25px; }

        /* Search & Filter Form */
        .filter-form { margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; display: grid; grid-template-columns: 2fr 1fr auto; gap: 10px; align-items: flex-end; }
        .filter-form .form-group { display: flex; flex-direction: column; }
        .filter-form label { font-weight: 600; font-size: 0.85em; margin-bottom: 5px; color: #495057; }
        .filter-form input[type="text"], .filter-form select {
            padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        .filter-form .btn-group { display: flex; gap: 5px; }
        .filter-form button { padding: 8px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .filter-form a { padding: 8px 15px; background-color: #6c757d; color: white; border-radius: 4px; text-decoration: none; font-size: 0.9em; text-align: center; box-sizing: border-box; }

        /* Table Styling */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; vertical-align: top; font-size: 0.95em; }
        th { background-color: #343a40; color: white; font-weight: 600; }
        th a { color: inherit; text-decoration: none; } /* Sort links */
        th a:hover { text-decoration: underline; }
        .sort-asc::after { content: " ‚ñ≤"; font-size: 0.8em; }
        .sort-desc::after { content: " ‚ñº"; font-size: 0.8em; }
        tr:hover { background-color: #f8f9fa; }

        /* Status and Action */
        .status-pending { color: #cc6600; font-weight: bold; }
        .action-link { background-color: #ffc107; color: #343a40; padding: 5px 10px; border-radius: 4px; text-decoration: none; font-weight: bold; }
        .action-link:hover { background-color: #e0a800; }
        .footer-nav { margin-top: 20px; }
        .description-cell { max-width: 400px; word-wrap: break-word; }

        /* --- Hint Box Styles --- */
        .hint-section {
            margin-bottom: 25px;
            padding: 15px;
            background-color: #fff8e1;
            border: 1px solid #ffeeba;
            border-radius: 6px;
        }
        .hint-section h2 {
            font-size: 1.2em;
            color: #856404;
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 1px solid #ffeeba;
            padding-bottom: 5px;
        }
        .hint-box {
            padding: 10px;
            background-color: #fff;
            border: 1px solid #eee;
            border-left: 4px solid #ffc107;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px; /* Add gap */
        }
        .hint-box-content { flex-grow: 1; } /* Allow content to grow */
        .hint-box-content p { margin: 2px 0; }
        .hint-box-content .hint-title { font-weight: bold; color: #333; }
        .hint-box-content .hint-description { font-size: 0.9em; color: #555; }

        /* MODIFIED: Action group for buttons */
        .hint-box-action {
            display: flex;
            align-items: center;
            gap: 10px; /* Space between buttons */
        }
        .hint-box-action .btn-view {
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: bold;
            white-space: nowrap;
        }
        .hint-box-action .btn-view:hover { background-color: #0056b3; }

        /* NEW: Dismiss button style */
        .hint-box-action .btn-dismiss {
            padding: 4px 8px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
        }
        .hint-box-action .btn-dismiss:hover { background-color: #5a6268; }
        .hint-box-action form { margin: 0; }
        /* --- END NEW/MODIFIED --- */

        /* Pagination */
        .pagination { margin-top: 25px; text-align: center; }
        .pagination a, .pagination .current { display: inline-block; padding: 6px 12px; margin: 0 2px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #007bff; }
        .pagination .current { background-color: #007bff; color: white; border-color: #007bff; }
        .pagination a:hover { background-color: #f0f0f0; }
    </style>
</head>
<body>
<div class="container">
    {% include "tax_processor/base_navigation.html" %}

    <h1>{{ title }}</h1>

    {% if is_filtered %}
    <p><a href="{% url 'declaration_detail' current_declaration.id %}">‚Üê ’é’•÷Ä’°’§’°’º’∂’°’¨ ’Ä’°’µ’ø’°÷Ä’°÷Ä’°’£÷Ä’´’∂</a></p>
    {% endif %}

    {% if messages %}
    <ul class="messages">
        {% for message in messages %}
        <li class="{{ message.tags }}">{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}

    {% if is_filtered and hints %}
    <div class="hint-section">
        <h2>üí° ’é’•÷Ä’¨’∏÷Ç’Æ’∏÷Ç’©’µ’°’∂ ’°’Ø’∂’°÷Ä’Ø’∂’•÷Ä (Analysis Hints)</h2>
        {% for hint in hints %}
        <div class="hint-box">
            <div class="hint-box-content">
                <p class="hint-title">{{ hint.title }}</p>
                <p class="hint-description">{{ hint.description }}</p>
            </div>
            <div class="hint-box-action">
                <a href="{% url 'all_transactions_list' declaration_id=current_declaration.id %}?tx_ids={{ hint.related_transaction_ids|join:',' }}" target="_blank" class="btn-view">
                    ‘¥’´’ø’•’¨ ‘≥’∏÷Ä’Æ’°÷Ä÷Ñ’∂’•÷Ä’®
                </a>
                <form action="{% url 'dismiss_hint' hint.id %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn-dismiss" title="Dismiss this hint">X</button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    <form method="get" action="" class="filter-form">
        <div class="form-group">
            <label for="q">’à÷Ä’∏’∂’•’¨</label>
            <input type="text" name="q" id="q" value="{{ search_query }}" placeholder="’à÷Ä’∏’∂’•’¨ ’∂’Ø’°÷Ä’°’£÷Ä’∏÷Ç’©’µ’°’¥’¢ ’Ø’°’¥ ’∏÷Ç’≤’°÷Ä’Ø’∏’≤’∏’æ...">
        </div>

        {% if is_admin and not is_filtered %}
        <div class="form-group">
            <label for="filter_user">’ï’£’ø’°’ø’•÷Ä</label>
            <select name="filter_user" id="filter_user">
                <option value="">‘≤’∏’¨’∏÷Ä’®</option>
                {% for user in all_users %}
                <option value="{{ user.id }}" {% if filter_user == user.id|stringformat:"s" %}selected{% endif %}>{{ user.username }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <div class="btn-group">
            <button type="submit">’à÷Ä’∏’∂’•’¨</button>
            <a href="{% if is_filtered %}{% url 'review_queue_declaration' current_declaration.id %}{% else %}{% url 'review_queue' %}{% endif %}">’Ñ’°÷Ñ÷Ä’•’¨</a>
        </div>
    </form>


    {% if unmatched_items %}
    <table>
        <thead>
        <tr>
            <th>
                <a href="?sort={% if current_sort == 'transaction__transaction_date' %}-{% endif %}transaction__transaction_date&{{ get_params }}"
                   class="{% if 'transaction_date' in current_sort %}{% if '-' in current_sort %}sort-desc{% else %}sort-asc{% endif %}{% endif %}">
                    ‘±’¥’Ω’°’©’´’æ
                </a>
            </th>
            <th>
                <a href="?sort={% if current_sort == 'transaction__amount' %}-{% endif %}transaction__amount&{{ get_params }}"
                   class="{% if 'amount' in current_sort %}{% if '-' in current_sort %}sort-desc{% else %}sort-asc{% endif %}{% endif %}">
                    ‘≥’∏÷Ç’¥’°÷Ä / ‘±÷Ä’™’∏÷Ç’µ’©
                </a>
            </th>
            {% if not is_filtered %}
            <th>
                <a href="?sort={% if current_sort == 'transaction__statement__declaration__name' %}-{% endif %}transaction__statement__declaration__name&{{ get_params }}"
                   class="{% if 'declaration__name' in current_sort %}{% if '-' in current_sort %}sort-desc{% else %}sort-asc{% endif %}{% endif %}">
                    ’Ä’°’µ’ø’°÷Ä’°÷Ä’°’£÷Ä’∏÷Ç’¥
                </a>
            </th>
            {% endif %}
            <th>’Ü’Ø’°÷Ä’°’£÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ ÷á ’à÷Ç’≤’°÷Ä’Ø’∏’≤</th>
            <th>‘ø’°÷Ä’£’°’æ’´’≥’°’Ø</th>
            <th>‘≥’∏÷Ä’Æ’∏’≤’∏÷Ç’©’µ’∏÷Ç’∂</th>
        </tr>
        </thead>
        <tbody>
        {% for item in unmatched_items %} {# unmatched_items is page_obj #}
        <tr>
            <td nowrap>{{ item.transaction.transaction_date|date:"Y-m-d H:i" }}</td>
            <td nowrap><strong>{{ item.transaction.amount|floatformat:2 }} {{ item.transaction.currency }}</strong></td>
            {% if not is_filtered %}
            <td>{{ item.transaction.statement.declaration.name }}</td>
            {% endif %}
            <td class="description-cell">
                {{ item.transaction.description|truncatechars:100 }}<br>
                <small>’à÷Ç’≤’°÷Ä’Ø’∏’≤: {{ item.transaction.sender }}</small>
            </td>
            <td class="status-pending">{{ item.get_status_display }}</td>
            <td>
                <a href="{% url 'resolve_transaction' item.pk %}" class="action-link" target="_blank">‘º’∏÷Ç’Æ’•’¨</a>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>

    {% include "tax_processor/pagination_controls.html" %}

    {% else %}
    <p style="color: #28a745; font-weight: bold; margin-top: 20px;">
        {% if search_query or filter_user %}
        ’à÷Ä’∏’∂’¥’°’∂’®/÷Ü’´’¨’ø÷Ä’´’∂ ’∞’°’¥’°’∫’°’ø’°’Ω’≠’°’∂’∏’≤ ’£’∏÷Ä’Æ’°÷Ä÷Ñ’∂’•÷Ä ’π’•’∂ ’£’ø’∂’æ’•’¨÷â
        {% else %}
        üéâ ’Å’•÷Ä ’æ’•÷Ä’°’∂’°’µ’¥’°’∂ ’∞’•÷Ä’©’® ’¥’°÷Ñ’∏÷Ç÷Ä ’ß:
        {% endif %}
    </p>
    {% endif %}
</div>
</body>
</html>
